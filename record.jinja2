<!doctype html>
<html>
<head>
    <title>killstreak</title>
    <link rel="stylesheet" type="text/css" href="/css/reset.css">
    <style>
        header {
            text-align: center;
        }
        .record {
            padding-top: 2em;
            position: relative;
        }
        .tooltip {
            display: none;
            position: absolute; top: 0; left: 0; right: 0;
            color: #555; font-family: sans-serif; font-size: 2em;
            text-align: center;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }

        /* Flexbox settings */
        .days {
            display: -webkit-box; -webkit-box-wrap: wrap;
            display: -moz-box; -moz-box-wrap: wrap;
            display: -ms-flexbox; -ms-flexbox-wrap: wrap;
            display: -webkit-flex; -webkit-flex-wrap: wrap;
            display: flex; flex-wrap: wrap;
        }
        .day,
        .day-name,
        .placeholder {
            border-style: solid; border-width: 1px; border-color: #ccc;
            display: inline-block;
            height: 1em; width: 1em;
            margin-left: -1px; margin-top: -1px;
        }

        /* Clickable date blocks */
        .day:hover {
            background-color: #eee;
        }
        .day.set {
            background-color: #a0d020;
        }
        .day.set:hover {
            background-color: #b0e030;
        }
        .day:hover .tooltip {
            display: block;
        }

        /* Day of week & placeholder blocks, used in weekly view */
        .day-name,
        .placeholder {
            text-align: center;
            border-color: rgba(0,0,0,0);
            display: none;  /* Hide blocks unless using weekly view */
        }
        .day-name span {
            color: #555; font-family: sans-serif; font-size: 0.8em;
        }
        .weekly .days {
            max-height: 8em;
            -webkit-flex-direction: column; -webkit-align-content: flex-start;
        }
        .weekly .placeholder,
        .weekly .day-name {
            display: inline-block;
        }

        /* Un-highlightable text */
        .day-name span,
        .tooltip {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }
    </style>
</head>
<body>
    <header><a href="/r/">home</a></header>
    <form name="set_name" method="post">
        <label for="name">name</label>
        <input type="text" name="name" value="{{ record.name|e }}">
        <input type="hidden" name="method" value="set_name"></input>
        <input type="submit">
    </form>
    <form name="set_startdate" method="post">
        <label for="date">start date</label>
        <input type="text" name="date" value="{{ record.start_date }}">
        <input type="hidden" name="method" value="set_start"></input>
        <input type="submit">
    </form>
    <div class="record weekly">
        <div class="days">
            <div class="day-name"></div>
            <div class="day-name"><span>M</span></div>
            <div class="day-name"></div>
            <div class="day-name"><span>W</span></div>
            <div class="day-name"></div>
            <div class="day-name"><span>F</span></div>
            <div class="day-name"></div>
            {%- for i in range((record.start_date.isoweekday()) % 7) -%}
            <div class="placeholder"></div>
            {%- endfor -%}
            {%- for d in record.calendar -%}
            <div class="day{% if d[0] %} set{% endif %}">
                <div class="tooltip">{{ d[1]|e }}</div>
            </div>
            {%- endfor -%}
    </div>
    </div>
    <script>
(function() {
    function day_click_callback(e) {
        toggle_node(e.target);
    }

    function send_request(method, date) {
        var data, xhr;
        data = new FormData();
        data.append('method', method);
        data.append('date', date);
        xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                console.log(xhr.status);
                console.log(xhr.responseText);
            }
        };
        xhr.open('post', window.location.href);
        xhr.send(data);
    }

    function set_date(date) {
        send_request('set', date);
    }

    function set_name(name) {
        send_request('set_name', name);
    }

    function set_start(date) {
        send_request('set_start', date);
    }

    function toggle_node(dayNode) {
        var date;
        date = dayNode.querySelector('.tooltip').textContent;
        if (dayNode.classList.contains('set')) {
            unset_date(date);
            dayNode.classList.remove('set');
        } else {
            set_date(date);
            dayNode.classList.add('set');
        }
    }

    function unset_date(date) {
        send_request('unset', date);
    }

    var dayNodes, i;
    dayNodes = document.getElementsByClassName('day');
    for (i=0; i<dayNodes.length; i++) {
        dayNodes[i].addEventListener('click', day_click_callback, false);
    }
}());
    </script>
</body>
</html>
